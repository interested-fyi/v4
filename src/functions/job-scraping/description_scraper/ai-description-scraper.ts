import OpenAI from 'openai';
import extractJobBody from './extract-job-body';

export default async function extractJobData(url: string) {
    const openai = new OpenAI({apiKey: process.env.OPENAI_API_KEY});
    const inputBody = await extractJobBody(url);
    let generatedText = '{}';

    const response = await openai.chat.completions.create({
        model: 'gpt-4o',
        response_format: { type: 'json_object'},
        messages: [
            {role: 'system', content: `I am a job description scraper that takes the <body> element source code and replies with JSON of the following fields. Note in the description HTML or description fields, do not include the application form. If it does not look like a job description or job posting web page, please set all fields in the JSON to null:
            description - all the text content of the job description, including responsibilities and qualifications and any other sub sections
            title - the job position title or role
            location - the job location (or remote)
            compensation - salary range or null (formatted as either "$100,000" or as "$85,000 - $125,000", make sure to include the currency symbol in front of all numbers)
            summary - a generated 3-4 sentence summary of the job posting`},
            {role: "user", content: "URL: https://jobs.lever.co/tokenmetrics/43e9d3be-a4ec-4a23-b398-e9bbca08e378/\nSource: <body class=\"show header-compact\"><div class=\"page show\"><div class=\"main-header page-full-width section-wrapper\"><div class=\"main-header-content page-centered narrow-section page-full-width\"><a class=\"main-header-logo\" href=\"https://jobs.lever.co/tokenmetrics\"><img alt=\"Token Metrics logo\" src=\"https://lever-client-logos.s3.us-west-2.amazonaws.com/8b18c5be-559d-4059-9a69-606be455d7c0-1599379409140.png\"/></a></div></div></div><div class=\"content-wrapper posting-page\"><div class=\"content\"><div class=\"section-wrapper accent-section page-full-width\"><div class=\"section page-centered posting-header\"><div class=\"posting-headline\"><h2>Crypto Senior Full Stack Developer (Jakarta - Remote)</h2><div class=\"posting-categories\"><div class=\"sort-by-time posting-category medium-category-label width-full capitalize-labels location\" href=\"#\">Jakarta</div><div class=\"sort-by-team posting-category medium-category-label capitalize-labels department\" href=\"#\">Engineering Team /</div><div class=\"sort-by-commitment posting-category medium-category-label capitalize-labels commitment\" href=\"#\">Full-Time /</div><div class=\"sort-by-time posting-category medium-category-label capitalize-labels workplaceTypes\" href=\"#\">Remote</div></div></div><div class=\"postings-btn-wrapper\"><a class=\"postings-btn template-btn-submit hex-color\" href=\"https://jobs.lever.co/tokenmetrics/43e9d3be-a4ec-4a23-b398-e9bbca08e378/apply\">Apply for this job</a></div></div></div><div class=\"section-wrapper page-full-width\"><div class=\"section page-centered\" data-qa=\"job-description\"><div>Token Metrics is looking for a highly skilled Senior Full-Stack Engineer who will be responsible for designing and developing front-end, back-end and architecture, ensuring the responsiveness of applications and working alongside design team for web design features, among other duties. Senior Full Stack Developer will be required to see out a project from conception to final product, requiring good organizational skills and attention to detail.</div></div><div class=\"section page-centered\"><div><h3>Full Stack Developer Responsibilities</h3><ul class=\"posting-requirements plain-list\"><ul><li>Developing front end website architecture.</li><li>Designing user interactions on web pages.</li><li>Developing back end website applications.</li><li>Creating servers and databases for functionality.</li><li>Ensuring cross-platform optimization for mobile phones.</li><li>Ensuring responsiveness of applications.</li><li>Working alongside graphic designers for web design features.</li><li>Seeing through a project from conception to finished product.</li><li>Designing and developing APIs.</li><li>Meeting both technical and consumer needs.</li><li>Staying abreast of developments in web applications and programming languages.</li></ul></ul></div></div><div class=\"section page-centered\"><div><h3>Full Stack Developer Requirements</h3><ul class=\"posting-requirements plain-list\"><ul><li>Degree in Computer Science.</li><li>Strong organizational and project management skills.</li><li>Proficiency with fundamental front end languages such as HTML, CSS and JavaScript.</li><li>Familiarity with JavaScript frameworks such as Angular JS, React.</li><li>Proficiency with server side languages such as Python, Node Js, .Net.</li><li>Familiarity with database technology such as MySQL, Oracle and MongoDB.</li><li>Excellent verbal communication skills.</li><li>Good problem solving skills.</li><li>Attention to detail.</li></ul></ul></div></div><div class=\"section page-centered\" data-qa=\"closing-description\"><div><span style=\"font-size: 24px\">About Token Metrics</span></div><div><br/></div><div>Token Metrics helps crypto investors build profitable portfolios using artificial intelligence based crypto indices, rankings, and price predictions.\u00a0</div><div><br/></div><div>Token Metrics has a diverse set of customers, from retail investors and traders to crypto fund managers, in more than 50 countries.</div></div><div class=\"section page-centered last-section-apply\" data-qa=\"btn-apply-bottom\"><a class=\"postings-btn template-btn-submit hex-color\" data-qa=\"show-page-apply\" href=\"https://jobs.lever.co/tokenmetrics/43e9d3be-a4ec-4a23-b398-e9bbca08e378/apply\">Apply for this job</a></div></div></div></div><div class=\"main-footer page-full-width\"><div class=\"main-footer-text page-centered\"><p><a href=\"https://tokenmetrics.com\">Token Metrics Home Page</a></p><a class=\"image-link\" href=\"https://www.lever.co/job-seeker-support/\"><span>Jobs powered by </span><img alt=\"Lever logo\" src=\"/img/lever-logo-full.svg\"/></a></div></div><script type=\"application/ld+json\">{\"@context\" : \"http://schema.org\",\"@type\" : \"JobPosting\",\"title\" : \"Crypto Senior Full Stack Developer (Jakarta - Remote)\",\"hiringOrganization\" : {\"@type\" : \"Organization\",\"name\": \"Token Metrics\",\"logo\": \"https://lever-client-logos.s3.us-west-2.amazonaws.com/8b18c5be-559d-4059-9a69-606be455d7c0-1599379409140.png\"},\"jobLocation\":{\"@type\" : \"Place\",\"address\" : {\"@type\" : \"PostalAddress\",\"addressLocality\" : \"Jakarta\",\"addressRegion\" : null,\"addressCountry\" : null,\"postalCode\" : null}},\"employmentType\" : \"Full-Time\",\"datePosted\" : \"2023-02-17\",\"description\" : \"<p>Token Metrics is looking for a highly skilled Senior Full-Stack Engineer who will be responsible for designing and developing front-end, back-end and architecture, ensuring the responsiveness of applications and working alongside design team for web design features, among other duties. Senior Full Stack Developer will be required to see out a project from conception to final product, requiring good organizational skills and attention to detail.</p>\\\\n<p><p><br></p><b>Full Stack Developer Responsibilities</b><ul><li>Developing front end website architecture.</li><li>Designing user interactions on web pages.</li><li>Developing back end website applications.</li><li>Creating servers and databases for functionality.</li><li>Ensuring cross-platform optimization for mobile phones.</li><li>Ensuring responsiveness of applications.</li><li>Working alongside graphic designers for web design features.</li><li>Seeing through a project from conception to finished product.</li><li>Designing and developing APIs.</li><li>Meeting both technical and consumer needs.</li><li>Staying abreast of developments in web applications and programming languages.</li></ul><p><br></p><b>Full Stack Developer Requirements</b><ul><li>Degree in Computer Science.</li><li>Strong organizational and project management skills.</li><li>Proficiency with fundamental front end languages such as HTML, CSS and JavaScript.</li><li>Familiarity with JavaScript frameworks such as Angular JS, React.</li><li>Proficiency with server side languages such as Python, Node Js, .Net.</li><li>Familiarity with database technology such as MySQL, Oracle and MongoDB.</li><li>Excellent verbal communication skills.</li><li>Good problem solving skills.</li><li>Attention to detail.</li></ul><p><br></p></p>\\\\n<p><span style=\\\"font-size: 24px\\\">About Token Metrics</span></p><p><br></p><p>Token Metrics helps crypto investors build profitable portfolios using artificial intelligence based crypto indices, rankings, and price predictions.&nbsp;</p><p><br></p><p>Token Metrics has a diverse set of customers, from retail investors and traders to crypto fund managers, in more than 50 countries.</p>\"}</script><script data-apikey=\"6a247c6ff13012d02fde17377f0b857b\" data-appversion=\"0.0.1720459293\" data-endpoint=\"https://bugs.lever.co/js\" data-releasestage=\"production\" src=\"/js/bug-snag.js\"></script></body>"}, 
            {role: "assistant", content: "{\"description\": \"Token Metrics is looking for a highly skilled Senior Full-Stack Engineer who will be responsible for designing and developing front-end, back-end and architecture, ensuring the responsiveness of applications and working alongside design team for web design features, among other duties. Senior Full Stack Developer will be required to see out a project from conception to final product, requiring good organizational skills and attention to detail.\\r\\nFull Stack Developer Responsibilities\\r\\nDeveloping front end website architecture.\\r\\nDesigning user interactions on web pages.\\r\\nDeveloping back end website applications.\\r\\nCreating servers and databases for functionality.\\r\\nEnsuring cross-platform optimization for mobile phones.\\r\\nEnsuring responsiveness of applications.\\r\\nWorking alongside graphic designers for web design features.\\r\\nSeeing through a project from conception to finished product.\\r\\nDesigning and developing APIs.\\r\\nMeeting both technical and consumer needs.\\r\\nStaying abreast of developments in web applications and programming languages.\\r\\nFull Stack Developer Requirements\\r\\nDegree in Computer Science.\\r\\nStrong organizational and project management skills.\\r\\nProficiency with fundamental front end languages such as HTML, CSS and JavaScript.\\r\\nFamiliarity with JavaScript frameworks such as Angular JS, React.\\r\\nProficiency with server side languages such as Python, Node Js, .Net.\\r\\nFamiliarity with database technology such as MySQL, Oracle and MongoDB.\\r\\nExcellent verbal communication skills.\\r\\nGood problem solving skills.\\r\\nAttention to detail.\\r\\nAbout Token Metrics\\r\\n\\r\\nToken Metrics helps crypto investors build profitable portfolios using artificial intelligence based crypto indices, rankings, and price predictions. \\r\\n\\r\\nToken Metrics has a diverse set of customers, from retail investors and traders to crypto fund managers, in more than 50 countries.\", \"title\": \"Crypto Senior Full Stack Developer\", \"location\": \"Jakarta - Remote\", \"compensation\": null, \"summary\": \"Token Metrics is seeking a Senior Full-Stack Developer responsible for designing and developing both front-end and back-end architecture, ensuring application responsiveness, and collaborating with the design team. Key duties include developing website architecture, creating servers and databases, optimizing cross-platform functionality, and designing APIs. Candidates should have a degree in Computer Science, strong organizational skills, proficiency in HTML, CSS, JavaScript, and server-side languages like Python and Node.js, as well as familiarity with databases such as MySQL and MongoDB. Excellent communication and problem-solving skills are essential.\\r\\n\\r\\n\"}"},
            {role: "user", content: `URL: ${url}\nSource: ${inputBody.body}`}
        ]
    });

    generatedText += response.choices[0].message.content;
    return { role: response.choices[0].message.role, content: JSON.parse(generatedText) }; 
}